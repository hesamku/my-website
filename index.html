<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HESAM-KU License Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: Tahoma, sans-serif; }
        .license-panel { margin-top: 50px; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .status-active { color: #198754; font-weight: bold; }
        .status-expired { color: #dc3545; font-weight: bold; }
        .status-low { color: #ffc107; font-weight: bold; }
        .logo { font-size: 2rem; font-weight: 700; color: #0d6efd; margin-bottom: 20px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .card-header-custom { background: linear-gradient(90deg, #0d6efd, #00bfff); color: white; border-bottom: none; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-view" class="row justify-content-center">
        <div class="col-md-6 license-panel">
            <h2 class="text-center logo">ğŸ”‘ HESAM-KU Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª</h2>
            <form id="login-form">
                <div class="mb-3">
                    <label for="username" class="form-label">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (1234)</label>
                    <input type="text" class="form-control" id="username" required>
                </div>
                <div class="mb-3">
                    <label for="password" class="form-label">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± (1234)</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„</button>
                <div id="login-error" class="text-danger mt-3 text-center" style="display: none;"></div>
            </form>
        </div>
    </div>

    <div id="admin-view" class="license-panel" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="logo">âš™ï¸ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª Ù„Ø§ÛŒØ³Ù†Ø³</h2>
            <button id="logout-btn" class="btn btn-sm btn-outline-danger">Ø®Ø±ÙˆØ¬</button>
        </div>
        
        <div class="card mb-4 border-0 shadow-sm">
            <div class="card-header card-header-custom">
                Ø³Ø§Ø®Øª Ù„Ø§ÛŒØ³Ù†Ø³ Ø¬Ø¯ÛŒØ¯
            </div>
            <div class="card-body">
                <form id="create-license-form" class="row g-3">
                    <div class="col-md-4">
                        <label for="license-days" class="form-label">Ù…Ø¯Øª Ø²Ù…Ø§Ù† (Ø±ÙˆØ²)</label>
                        <input type="number" class="form-control" id="license-days" value="30" required min="1">
                    </div>
                    <div class="col-md-8 d-flex align-items-end">
                        <button type="submit" class="btn btn-success w-100">ØªÙˆÙ„ÛŒØ¯ Ùˆ Ø«Ø¨Øª Ù„Ø§ÛŒØ³Ù†Ø³</button>
                    </div>
                </form>
                <div id="create-result" class="mt-3 alert" style="display: none;"></div>
            </div>
        </div>

        <h4>Ù„ÛŒØ³Øª Ú©Ø§Ù…Ù„ Ù„Ø§ÛŒØ³Ù†Ø³â€ŒÙ‡Ø§</h4>
        <div class="table-responsive">
            <table class="table table-striped table-hover align-middle">
                <thead>
                    <tr>
                        <th>Ú©Ù„ÛŒØ¯ Ù„Ø§ÛŒØ³Ù†Ø³</th>
                        <th>ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§</th>
                        <th>Ø±ÙˆØ² Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡</th>
                        <th>ÙˆØ¶Ø¹ÛŒØª</th>
                        <th>Ø¹Ù…Ù„ÛŒØ§Øª</th>
                    </tr>
                </thead>
                <tbody id="license-table-body">
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const API_BASE = '/api';
    let authToken = localStorage.getItem('authToken');

    async function apiFetch(endpoint, options = {}) {
        options.headers = {
            ...options.headers,
            'Authorization': `Bearer ${authToken}`,
            'Content-Type': 'application/json'
        };
        const response = await fetch(API_BASE + endpoint, options);

        if (response.status === 401 || response.status === 403) {
            alert('Ù†Ø´Ø³Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´Ù…Ø§ Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.');
            logout();
            throw new Error('Unauthorized');
        }
        return response.json();
    }

    function toggleViews(isLoggedIn) {
        document.getElementById('login-view').style.display = isLoggedIn ? 'none' : 'flex';
        document.getElementById('admin-view').style.display = isLoggedIn ? 'block' : 'none';
    }

    // --- Ù„Ø§Ú¯ÛŒÙ† ---
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const errorDiv = document.getElementById('login-error');

        try {
            const response = await fetch(API_BASE + '/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();

            if (data.success) {
                authToken = data.token;
                localStorage.setItem('authToken', authToken);
                errorDiv.style.display = 'none';
                toggleViews(true);
                loadLicenseList();
            } else {
                errorDiv.textContent = data.message || 'Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.';
                errorDiv.style.display = 'block';
            }
        } catch (error) {
            errorDiv.textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ù‚Ø±Ø§Ø±ÛŒ Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±.';
            errorDiv.style.display = 'block';
        }
    });

    // --- Ø®Ø±ÙˆØ¬ ---
    function logout() {
        authToken = null;
        localStorage.removeItem('authToken');
        toggleViews(false);
    }
    document.getElementById('logout-btn').addEventListener('click', logout);

    // --- Ù„ÛŒØ³Øª Ù„Ø§ÛŒØ³Ù†Ø³â€ŒÙ‡Ø§ ---
    async function loadLicenseList() {
        try {
            const data = await apiFetch('/license/list');
            const tbody = document.getElementById('license-table-body');
            tbody.innerHTML = ''; 

            data.licenses.forEach(license => {
                const tr = document.createElement('tr');
                let statusText = license.status === 'active' ? 'ÙØ¹Ø§Ù„' : 'Ù…Ù†Ù‚Ø¶ÛŒ';
                let statusClass = 'status-active';

                if (license.status === 'expired') {
                    statusClass = 'status-expired';
                    statusText = 'Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡';
                } else if (license.remainingDays <= 7) {
                    statusClass = 'status-low';
                    statusText = 'Ø¯Ø± Ø­Ø§Ù„ Ø§ØªÙ…Ø§Ù…';
                }
                
                tr.innerHTML = `
                    <td><code>${license.key}</code></td>
                    <td>${license.expires}</td>
                    <td>${license.remainingDays} Ø±ÙˆØ²</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td>
                        <button class="btn btn-sm btn-info renew-btn" data-key="${license.key}">ØªÙ…Ø¯ÛŒØ¯ Û³Û° Ø±ÙˆØ²</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            document.querySelectorAll('.renew-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const key = e.target.getAttribute('data-key');
                    renewLicense(key);
                });
            });

        } catch (error) {
            console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ù„Ø§ÛŒØ³Ù†Ø³â€ŒÙ‡Ø§:", error);
        }
    }

    // --- Ø³Ø§Ø®Øª Ù„Ø§ÛŒØ³Ù†Ø³ ---
    document.getElementById('create-license-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const days = document.getElementById('license-days').value;
        const resultDiv = document.getElementById('create-result');

        try {
            const data = await apiFetch('/license/create', {
                method: 'POST',
                body: JSON.stringify({ days: parseInt(days, 10) })
            });

            if (data.success) {
                resultDiv.className = 'mt-3 alert alert-success';
                resultDiv.textContent = `âœ… Ù„Ø§ÛŒØ³Ù†Ø³ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø³Ø§Ø®ØªÙ‡ Ùˆ Ø«Ø¨Øª Ø´Ø¯: ${data.key}. ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§: ${data.expires}`;
                loadLicenseList(); 
            } else {
                resultDiv.className = 'mt-3 alert alert-danger';
                resultDiv.textContent = data.message || 'Ø®Ø·Ø§ Ø¯Ø± Ø³Ø§Ø®Øª Ù„Ø§ÛŒØ³Ù†Ø³.';
            }
            resultDiv.style.display = 'block';
        } catch (error) {
             resultDiv.className = 'mt-3 alert alert-danger';
             resultDiv.textContent = 'Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø³Ø±ÙˆØ± Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… Ø³Ø§Ø®Øª Ù„Ø§ÛŒØ³Ù†Ø³. (Ø´Ø§ÛŒØ¯ Ù„Ø§Ú¯ÛŒÙ† Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯)';
             resultDiv.style.display = 'block';
        }
    });

    // --- ØªÙ…Ø¯ÛŒØ¯ Ù„Ø§ÛŒØ³Ù†Ø³ ---
    async function renewLicense(key) {
        if (!confirm(`Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ù„Ø§ÛŒØ³Ù†Ø³ ${key} Ø±Ø§ Ø¨Ù‡ Ù…Ø¯Øª Û³Û° Ø±ÙˆØ² ØªÙ…Ø¯ÛŒØ¯ Ú©Ù†ÛŒØ¯ØŸ`)) {
            return;
        }

        try {
            const data = await apiFetch(`/license/renew/${key}`, {
                method: 'PUT',
                body: JSON.stringify({ days: 30 }) 
            });

            if (data.success) {
                alert(`ØªØ¨Ø±ÛŒÚ©! ${data.message}`);
                loadLicenseList(); 
            } else {
                alert(data.message || 'Ø®Ø·Ø§ Ø¯Ø± ØªÙ…Ø¯ÛŒØ¯ Ù„Ø§ÛŒØ³Ù†Ø³.');
            }
        } catch (error) {
            alert('Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡ ÛŒØ§ Ø³Ø±ÙˆØ± Ø¯Ø± ØªÙ…Ø¯ÛŒØ¯ Ù„Ø§ÛŒØ³Ù†Ø³.');
        }
    }

    // ÙˆØ¶Ø¹ÛŒØª Ø§ÙˆÙ„ÛŒÙ‡
    if (authToken) {
        toggleViews(true);
        loadLicenseList();
    } else {
        toggleViews(false);
    }
</script>

</body>
</html>
